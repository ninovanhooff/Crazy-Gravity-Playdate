---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by ninovanhooff.
--- DateTime: 11/03/2022 16:29
---

import "util.lua"

local file <const> = playdate.file
local unpack <const> = string.unpack


local function setUnpackMeta(format)
    for x, xtem in ipairs(brickT) do
        local compressedXtem = { compressed = xtem}
        local unpackMeta = {
            __index = function(tbl, idx)
                return {unpack(format, tbl.compressed[idx])}
            end
        }

        brickT[x]= setmetatable(compressedXtem, unpackMeta)
    end
end

function LoadFile(path)
    printf("loading ".. path)

    levelT, brickT, specialT, levelProps = nil, nil, nil
    sample("GC", function() collectgarbage("collect")end)

    local levelT
    sample("pdz load", function() levelT = file.run(path..".pdz") end, 1)
    levelProps = levelT["levelProps"]
    levelProps.lives = levelProps.lives or 5
    specialT = levelT["specialT"]
    brickT = {}

    sample("bin load", function()
        local brickFile = file.open(path..".bin")
        for x = 1, levelProps.sizeX do
            brickT[x] = {}
            for y = 1, levelProps.sizeY do
                brickT[x][y] = brickFile:read(5)
            end
        end
    end, 1)

    sample("set unpack meta", function()
        setUnpackMeta(levelProps.packFormat)
    end, 1)


    printf("loaded dim",#brickT,#brickT[1])

    return true
end
